<!DOCTYPE html>
<html lang="en">
<head>
      <meta charset="utf-8" />
    <title>Ben Fisher &middot; Aggregating ICEWS Data in R</title>
    <link rel="shortcut icon" type="image/png" href="./favicon.png">
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico">
    <link rel="stylesheet" href="./theme/css/screen.css" type="text/css" />
    <link rel="stylesheet" href="./theme/css/pygments.css" type="text/css" />
    <link rel="stylesheet" href="./theme/css/print.css" type="text/css" media="print" />
    <meta name="generator" content="Pelican" />



</head>
<body>
    <header>
        <nav>
                <li><a href=".">Home</a></li>
                <li><a href="./pages/about.html">About Me</a></li>
                <li><a href="./archives.html">Archives</a></li>
        </nav>
        <div class="header_box">
            <h1><a href=".">Ben Fisher</a></h1>
        </div>
    </header>
    <div id="wrapper">
        <div id="content">
            <h4 class="date">Apr 28, 2015</h4>
            <article class="post">
<h2 class="title">
                    <a href="./aggregating-icews-data-in-r.html" rel="bookmark" title="Permanent Link to &quot;Aggregating ICEWS Data in R&quot;">Aggregating ICEWS Data in R</a>
                </h2>

                <p>This is going to be a walkthrough of an R function I've written, which can be found <a href="https://github.com/bensfisher/aggregate_icews">here</a> that aggregates the
recently (finally!) released ICEWS data. <code>aggregate_icews</code> converts the data into country-month
observations with columns counting events <strong><em>internal</em></strong> to a country by type and 
actor combination. For example, the <code>gov_reb_matcf</code> variable would be a count
of material conflict events where the government was the source and a rebel group
was the target. The event types are based on the standard quad categories: verbal
cooperation, material cooperation, verbal conflict, and material conflict. The 
different actor types are based off groupings of agent types from the text_to_CAMEO
program. The groupings are:</p>
<ul>
<li>GOV - government actors, grouped from GOV, MIL, JUD</li>
<li>REB - rebel actors, grouped from REB, INS, IMG</li>
<li>OPP - political opposition, from just OPP</li>
<li>CVL - civil society, grouped from EDU, MED, HLH, CVL, BUS</li>
<li>IOS - international organizations, grouped from IGO, NGO</li>
<li>USA - United States</li>
</ul>
<p>Now, this is just how I've decided to group them. There's obviously a lot of ways
this could be done, and it only takes adding/deleting a line or two of code in the
function to add or change a grouping. </p>
<p>Since the format that the ICEWS data comes in is not particularly easy to use,
you'll need to first run Phil Schrodt's <a href="https://github.com/philip-schrodt/text_to_CAMEO">text_to_CAMEO program</a>. If you don't have
any experience with Python, you can run the program from R using the <code>rPython</code>
package. Just make sure that the text_to_CAMEO and ICEWS files are all in your
working directory.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">library</span><span class="p">(</span><span class="n">rPython</span><span class="p">)</span>
<span class="n">setwd</span><span class="p">(</span><span class="err">&#39;</span><span class="n">directory</span><span class="o">/</span><span class="n">with</span><span class="o">/</span><span class="n">files</span><span class="o">/</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">python</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="err">&#39;</span><span class="n">text_to_CAMEO</span><span class="p">.</span><span class="n">py</span><span class="err">&#39;</span><span class="p">)</span> <span class="err">#</span> <span class="n">runs</span> <span class="n">the</span> <span class="n">python</span> <span class="n">program</span><span class="p">,</span> <span class="n">it</span> <span class="n">may</span> <span class="n">take</span> <span class="n">a</span> <span class="n">minute</span> <span class="n">or</span> <span class="n">two</span>
</pre></div>
</td></tr></table>

<p>This will generate a tab-delimited text file for each year of ICEWS data. The
aggregation function takes a data frame as its main argument, so you'll want to 
read the text files into a data frame.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="nx">files</span> <span class="o">=</span> <span class="nx">list</span><span class="p">.</span><span class="nx">files</span><span class="p">(</span><span class="nx">pattern</span><span class="o">=</span><span class="s1">&#39;reduced.ICEWS.events.*.txt&#39;</span><span class="p">)</span>
<span class="nx">icews</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="k">do</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;rbind&#39;</span><span class="p">,</span> <span class="nx">lapply</span><span class="p">(</span><span class="nx">files</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="nx">read</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">header</span><span class="o">=</span><span class="nx">FALSE</span><span class="p">,</span>
    <span class="nx">sep</span><span class="o">=</span><span class="s1">&#39;\t&#39;</span><span class="p">)))</span>
</pre></div>
</td></tr></table>

<p>Now that we have the data ready to aggregate, I'm going to walk through the
<code>aggregate_icews</code> function so that you can get an idea of how it works. I expect most people
will end up modifying the function in some way for different aggregations.</p>
<p>In the first section, I create a vector of actor groupings, <code>var_actors</code>, a list
of the quad categories and their corresponding numerical codes, <code>var_types</code>,
and a vector of labels for the variables I'm going to create, <code>variables</code>. It's 
important to note that the function will only create a variable if it is listed
in the <code>variables</code> vector. So, if you wanted to only get counts for dyads involving
a government actor, then you would remove any label in <code>variables</code> that does not 
include 'gov'. </p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="highlight"><pre><span class="nx">aggregate_icews</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">df</span><span class="p">){</span>
    <span class="nx">require</span><span class="p">(</span><span class="nx">lubridate</span><span class="p">)</span>
    <span class="nx">require</span><span class="p">(</span><span class="nx">dplyr</span><span class="p">)</span>
    <span class="nx">require</span><span class="p">(</span><span class="nx">reshape2</span><span class="p">)</span>

    <span class="nx">var_actors</span> <span class="o">=</span> <span class="nx">c</span><span class="p">(</span><span class="s1">&#39;gov&#39;</span><span class="p">,</span><span class="s1">&#39;opp&#39;</span><span class="p">,</span><span class="s1">&#39;soc&#39;</span><span class="p">,</span><span class="s1">&#39;ios&#39;</span><span class="p">,</span><span class="s1">&#39;usa&#39;</span><span class="p">,</span><span class="s1">&#39;reb&#39;</span><span class="p">)</span>
    <span class="nx">var_types</span> <span class="o">=</span> <span class="nx">list</span><span class="p">(</span><span class="nx">vercp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">matcp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">vercf</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">matcf</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
    <span class="nx">variables</span> <span class="o">=</span> <span class="nx">c</span><span class="p">(</span><span class="s1">&#39;gov_gov_vercp&#39;</span><span class="p">,</span> <span class="s1">&#39;gov_gov_matcp&#39;</span><span class="p">,</span> <span class="s1">&#39;gov_gov_vercf&#39;</span><span class="p">,</span> <span class="s1">&#39;gov_gov_matcf&#39;</span><span class="p">,</span>
             <span class="s1">&#39;gov_gov_gold&#39;</span><span class="p">,</span> <span class="s1">&#39;gov_opp_vercp&#39;</span><span class="p">,</span> <span class="s1">&#39;gov_opp_matcp&#39;</span><span class="p">,</span> <span class="s1">&#39;gov_opp_vercf&#39;</span><span class="p">,</span>
             <span class="s1">&#39;gov_opp_matcf&#39;</span><span class="p">,</span> <span class="s1">&#39;opp_gov_vercp&#39;</span><span class="p">,</span> <span class="s1">&#39;opp_gov_matcp&#39;</span><span class="p">,</span> <span class="s1">&#39;opp_gov_vercf&#39;</span><span class="p">,</span>
             <span class="s1">&#39;opp_gov_matcf&#39;</span><span class="p">,</span> <span class="s1">&#39;opp_gov_gold&#39;</span><span class="p">,</span> <span class="s1">&#39;gov_reb_vercp&#39;</span><span class="p">,</span> <span class="s1">&#39;gov_reb_matcp&#39;</span><span class="p">,</span>
             <span class="s1">&#39;gov_reb_vercf&#39;</span><span class="p">,</span> <span class="s1">&#39;gov_reb_matcf&#39;</span><span class="p">,</span> <span class="s1">&#39;gov_reb_gold&#39;</span><span class="p">,</span> <span class="s1">&#39;reb_gov_vercp&#39;</span><span class="p">,</span>
             <span class="s1">&#39;reb_gov_matcp&#39;</span><span class="p">,</span> <span class="s1">&#39;reb_gov_vercf&#39;</span><span class="p">,</span> <span class="s1">&#39;reb_gov_matcf&#39;</span><span class="p">,</span> <span class="s1">&#39;reb_gov_gold&#39;</span><span class="p">,</span>
             <span class="s1">&#39;gov_soc_vercp&#39;</span><span class="p">,</span> <span class="s1">&#39;gov_soc_matcp&#39;</span><span class="p">,</span> <span class="s1">&#39;gov_soc_vercf&#39;</span><span class="p">,</span> <span class="s1">&#39;gov_soc_matcf&#39;</span><span class="p">,</span>
             <span class="s1">&#39;gov_soc_gold&#39;</span><span class="p">,</span> <span class="s1">&#39;soc_gov_vercp&#39;</span><span class="p">,</span> <span class="s1">&#39;soc_gov_matcp&#39;</span><span class="p">,</span> <span class="s1">&#39;soc_gov_vercf&#39;</span><span class="p">,</span>
             <span class="s1">&#39;soc_gov_matcf&#39;</span><span class="p">,</span> <span class="s1">&#39;soc_gov_gold&#39;</span><span class="p">,</span> <span class="s1">&#39;gov_ios_vercp&#39;</span><span class="p">,</span> <span class="s1">&#39;gov_ios_matcp&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;gov_ios_vercf&#39;</span><span class="p">,</span> <span class="s1">&#39;gov_ios_matcf&#39;</span><span class="p">,</span> <span class="s1">&#39;gov_ios_gold&#39;</span><span class="p">,</span> <span class="s1">&#39;ios_gov_vercp&#39;</span><span class="p">,</span>
             <span class="s1">&#39;ios_gov_matcp&#39;</span><span class="p">,</span> <span class="s1">&#39;ios_gov_vercf&#39;</span><span class="p">,</span> <span class="s1">&#39;ios_gov_matcf&#39;</span><span class="p">,</span> <span class="s1">&#39;ios_gov_gold&#39;</span><span class="p">,</span>
             <span class="s1">&#39;gov_usa_vercp&#39;</span><span class="p">,</span> <span class="s1">&#39;gov_usa_matcp&#39;</span><span class="p">,</span> <span class="s1">&#39;gov_usa_vercf&#39;</span><span class="p">,</span> <span class="s1">&#39;gov_usa_matcf&#39;</span><span class="p">,</span>
             <span class="s1">&#39;gov_usa_gold&#39;</span><span class="p">,</span> <span class="s1">&#39;usa_gov_vercp&#39;</span><span class="p">,</span> <span class="s1">&#39;usa_gov_matcp&#39;</span><span class="p">,</span> <span class="s1">&#39;usa_gov_vercf&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;usa_gov_matcf&#39;</span><span class="p">,</span> <span class="s1">&#39;usa_gov_gold&#39;</span><span class="p">,</span> <span class="s1">&#39;opp_reb_vercp&#39;</span><span class="p">,</span> <span class="s1">&#39;opp_reb_matcp&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;opp_reb_vercf&#39;</span><span class="p">,</span> <span class="s1">&#39;opp_reb_matcf&#39;</span><span class="p">,</span> <span class="s1">&#39;opp_reb_gold&#39;</span><span class="p">,</span> <span class="s1">&#39;reb_opp_vercp&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;reb_opp_matcp&#39;</span><span class="p">,</span> <span class="s1">&#39;reb_opp_vercf&#39;</span><span class="p">,</span> <span class="s1">&#39;reb_opp_matcf&#39;</span><span class="p">,</span> <span class="s1">&#39;reb_opp_gold&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;opp_opp_vercp&#39;</span><span class="p">,</span> <span class="s1">&#39;opp_opp_matcp&#39;</span><span class="p">,</span> <span class="s1">&#39;opp_opp_vercf&#39;</span><span class="p">,</span> <span class="s1">&#39;opp_opp_matcf&#39;</span><span class="p">,</span>
             <span class="s1">&#39;opp_opp_gold&#39;</span><span class="p">,</span> <span class="s1">&#39;reb_reb_vercp&#39;</span><span class="p">,</span> <span class="s1">&#39;reb_reb_matcp&#39;</span><span class="p">,</span> <span class="s1">&#39;reb_reb_vercf&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;reb_reb_matcf&#39;</span><span class="p">,</span> <span class="s1">&#39;reb_reb_gold&#39;</span><span class="p">,</span> <span class="s1">&#39;opp_soc_vercp&#39;</span><span class="p">,</span> <span class="s1">&#39;opp_soc_matcp&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;opp_soc_vercf&#39;</span><span class="p">,</span> <span class="s1">&#39;opp_soc_matcf&#39;</span><span class="p">,</span> <span class="s1">&#39;opp_soc_gold&#39;</span><span class="p">,</span> <span class="s1">&#39;soc_opp_vercp&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;soc_opp_matcp&#39;</span><span class="p">,</span> <span class="s1">&#39;soc_opp_vercf&#39;</span><span class="p">,</span> <span class="s1">&#39;sco_opp_matcf&#39;</span><span class="p">,</span> <span class="s1">&#39;soc_opp_gold&#39;</span><span class="p">,</span>
             <span class="s1">&#39;opp_ios_vercp&#39;</span><span class="p">,</span> <span class="s1">&#39;opp_ios_matcp&#39;</span><span class="p">,</span> <span class="s1">&#39;opp_ios_vercf&#39;</span><span class="p">,</span> <span class="s1">&#39;opp_ios_matcf&#39;</span><span class="p">,</span>
             <span class="s1">&#39;opp_ios_gold&#39;</span><span class="p">,</span> <span class="s1">&#39;ios_opp_vercp&#39;</span><span class="p">,</span> <span class="s1">&#39;ios_opp_matcp&#39;</span><span class="p">,</span> <span class="s1">&#39;ios_opp_vercf&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;ios_opp_matcf&#39;</span><span class="p">,</span> <span class="s1">&#39;ios_opp_gold&#39;</span><span class="p">,</span> <span class="s1">&#39;opp_usa_vercp&#39;</span><span class="p">,</span> <span class="s1">&#39;opp_usa_matcp&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;opp_usa_vercf&#39;</span><span class="p">,</span> <span class="s1">&#39;opp_usa_matcf&#39;</span><span class="p">,</span> <span class="s1">&#39;opp_usa_gold&#39;</span><span class="p">,</span> <span class="s1">&#39;usa_opp_vercp&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;usa_opp_matcp&#39;</span><span class="p">,</span> <span class="s1">&#39;usa_opp_vercf&#39;</span><span class="p">,</span> <span class="s1">&#39;usa_opp_matcf&#39;</span><span class="p">,</span> <span class="s1">&#39;usa_opp_gold&#39;</span><span class="p">,</span>
             <span class="s1">&#39;soc_ios_vercp&#39;</span><span class="p">,</span> <span class="s1">&#39;soc_ios_matcp&#39;</span><span class="p">,</span> <span class="s1">&#39;soc_ios_vercf&#39;</span><span class="p">,</span> <span class="s1">&#39;soc_ios_matcf&#39;</span><span class="p">,</span>
             <span class="s1">&#39;soc_ios_gold&#39;</span><span class="p">,</span> <span class="s1">&#39;ios_soc_vercp&#39;</span><span class="p">,</span> <span class="s1">&#39;ios_soc_matcp&#39;</span><span class="p">,</span> <span class="s1">&#39;ios_soc_vercf&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;ios_soc_matcf&#39;</span><span class="p">,</span> <span class="s1">&#39;ios_soc_gold&#39;</span><span class="p">,</span> <span class="s1">&#39;soc_usa_vercp&#39;</span><span class="p">,</span> <span class="s1">&#39;soc_usa_matcp&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;soc_usa_vercf&#39;</span><span class="p">,</span> <span class="s1">&#39;soc_usa_matcf&#39;</span><span class="p">,</span> <span class="s1">&#39;soc_usa_gold&#39;</span><span class="p">,</span> <span class="s1">&#39;gov_gov_vercp&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;usa_soc_matcp&#39;</span><span class="p">,</span> <span class="s1">&#39;usa_soc_vercf&#39;</span><span class="p">,</span> <span class="s1">&#39;usa_soc_matcf&#39;</span><span class="p">,</span> <span class="s1">&#39;usa_soc_gold&#39;</span><span class="p">,</span>
             <span class="s1">&#39;soc_soc_vercp&#39;</span><span class="p">,</span> <span class="s1">&#39;soc_soc_matcp&#39;</span><span class="p">,</span> <span class="s1">&#39;soc_soc_vercf&#39;</span><span class="p">,</span> <span class="s1">&#39;soc_soc_matcf&#39;</span><span class="p">,</span>
             <span class="s1">&#39;soc_soc_gold&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p>Let's say we want to get counts for a specific event, rather than the bigger quad 
categories. Using the 'arrest/detain' category, we would alter <code>var_types</code> to
look something like</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">var_types</span> <span class="o">=</span> <span class="n">list</span><span class="p">(</span><span class="n">arrest</span> <span class="o">=</span> <span class="mi">173</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p>where 'arrest' is what we're going to call that variable type and 173 is the 
CAMEO code corresponding to arrest/detain. We would then edit the labels in <code>variables</code> 
accordingly (e.g. 'gov_opp_arrest','gov_soc_arrest', etc.).</p>
<p>In the next section, I filter the data frame so that I only have within-country
observations as well as those where the US was either the source are the target.
<code>all_actors</code> is a vector of countries that we are going to generate counts for.
Lines 5 through 10 create a few new variables to make aggregation easier and get
rid of those we no longer need. If you want to aggregate by day rather than month,
just generate a day column using <code>lubridate</code>'s <code>mday</code> function.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre>    <span class="n">colnames</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="err">&#39;</span><span class="n">date</span><span class="sc">&#39;,&#39;</span><span class="n">iso1</span><span class="sc">&#39;,&#39;</span><span class="n">cow1</span><span class="sc">&#39;,&#39;</span><span class="n">agent1</span><span class="sc">&#39;,&#39;</span><span class="n">iso2</span><span class="sc">&#39;,&#39;</span><span class="n">cow2</span><span class="sc">&#39;,&#39;</span><span class="n">agent2</span><span class="sc">&#39;,&#39;</span><span class="n">cameo</span><span class="sc">&#39;,&#39;</span><span class="n">goldstein</span><span class="sc">&#39;,&#39;</span><span class="n">quad</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">filter</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">as</span><span class="p">.</span><span class="n">character</span><span class="p">(</span><span class="n">df</span><span class="err">$</span><span class="n">iso1</span><span class="p">)</span> <span class="o">==</span> <span class="n">as</span><span class="p">.</span><span class="n">character</span><span class="p">(</span><span class="n">df</span><span class="err">$</span><span class="n">iso2</span><span class="p">)</span> <span class="o">|</span> <span class="n">df</span><span class="err">$</span><span class="n">iso1</span> <span class="o">==</span> <span class="err">&#39;</span><span class="n">USA</span><span class="err">&#39;</span> <span class="o">|</span> <span class="n">df</span><span class="err">$</span><span class="n">iso2</span> <span class="o">==</span> <span class="err">&#39;</span><span class="n">USA</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="n">all_actors</span> <span class="o">=</span> <span class="n">as</span><span class="p">.</span><span class="n">vector</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">df</span><span class="err">$</span><span class="n">iso1</span><span class="p">))</span>
    <span class="n">all_actors</span> <span class="o">=</span> <span class="n">all_actors</span><span class="p">[</span><span class="n">all_actors</span> <span class="o">!=</span> <span class="err">&#39;</span><span class="n">USA</span><span class="err">&#39;</span> <span class="o">&amp;</span> <span class="n">all_actors</span> <span class="o">!=</span> <span class="err">&#39;</span><span class="o">---</span><span class="err">&#39;</span> <span class="o">&amp;</span> <span class="n">nchar</span><span class="p">(</span><span class="n">all_actors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">df</span><span class="err">$</span><span class="n">Actor1Code</span> <span class="o">=</span> <span class="n">paste</span><span class="p">(</span><span class="n">df</span><span class="err">$</span><span class="n">iso1</span><span class="p">,</span> <span class="n">df</span><span class="err">$</span><span class="n">agent1</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="err">&#39;&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="err">$</span><span class="n">Actor2Code</span> <span class="o">=</span> <span class="n">paste</span><span class="p">(</span><span class="n">df</span><span class="err">$</span><span class="n">iso2</span><span class="p">,</span> <span class="n">df</span><span class="err">$</span><span class="n">agent2</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="err">&#39;&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="err">$</span><span class="n">date</span> <span class="o">=</span> <span class="n">as</span><span class="p">.</span><span class="n">Date</span><span class="p">(</span><span class="n">df</span><span class="err">$</span><span class="n">date</span><span class="p">)</span>
    <span class="n">df</span><span class="err">$</span><span class="n">year</span> <span class="o">=</span> <span class="n">year</span><span class="p">(</span><span class="n">df</span><span class="err">$</span><span class="n">date</span><span class="p">)</span>
    <span class="n">df</span><span class="err">$</span><span class="n">month</span> <span class="o">=</span> <span class="n">month</span><span class="p">(</span><span class="n">df</span><span class="err">$</span><span class="n">date</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">9</span><span class="p">)]</span>
</pre></div>
</td></tr></table>

<p>The next section creates actor type groupings based on the agent codes. Lines 10-11,
for example, assign the 'GOV' grouping to an observation if the agent code is 
'GOV', 'MIL', 'JUD', or 'PTY'. Creating new groupings is straightforward, but make
sure that <code>var_actors</code> and <code>variables</code> in the first section of the function are 
edited accordingly so that variables based on new groupings are actually created.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre>    <span class="err">#</span> <span class="n">generating</span> <span class="n">actor</span> <span class="n">types</span> <span class="err">#</span>
    <span class="n">df</span><span class="err">$</span><span class="n">actor1type</span> <span class="o">=</span> <span class="n">NA</span>
    <span class="n">df</span><span class="err">$</span><span class="n">actor2type</span> <span class="o">=</span> <span class="n">NA</span>
    <span class="n">check1</span> <span class="o">=</span> <span class="n">substr</span><span class="p">(</span><span class="n">df</span><span class="err">$</span><span class="n">Actor1Code</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="err">#</span> <span class="n">pulling</span> <span class="n">second</span> <span class="mi">3</span> <span class="n">letter</span> <span class="n">code</span> <span class="o">-</span> <span class="n">agent</span> <span class="n">type</span>
    <span class="n">check2</span> <span class="o">=</span> <span class="n">substr</span><span class="p">(</span><span class="n">df</span><span class="err">$</span><span class="n">Actor2Code</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="err">#</span> <span class="n">pulling</span> <span class="n">second</span> <span class="mi">3</span> <span class="n">letter</span> <span class="n">code</span> <span class="o">-</span> <span class="n">agent</span> <span class="n">type</span>
    <span class="n">df</span><span class="err">$</span><span class="n">actor1type</span><span class="p">[</span><span class="n">check1</span> <span class="o">==</span> <span class="err">&#39;</span><span class="n">OPP</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">OPP</span><span class="err">&#39;</span>
    <span class="n">df</span><span class="err">$</span><span class="n">actor2type</span><span class="p">[</span><span class="n">check2</span> <span class="o">==</span> <span class="err">&#39;</span><span class="n">OPP</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">OPP</span><span class="err">&#39;</span>
    <span class="n">df</span><span class="err">$</span><span class="n">actor1type</span><span class="p">[</span><span class="n">check1</span><span class="o">==</span> <span class="err">&#39;</span><span class="n">GOV</span><span class="err">&#39;</span> <span class="o">|</span> <span class="n">check1</span><span class="o">==</span><span class="err">&#39;</span><span class="n">MIL</span><span class="err">&#39;</span> <span class="o">|</span> <span class="n">check1</span><span class="o">==</span><span class="err">&#39;</span><span class="n">JUD</span><span class="err">&#39;</span> <span class="o">|</span> 
    <span class="n">check1</span><span class="o">==</span><span class="err">&#39;</span><span class="n">PTY</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">GOV</span><span class="err">&#39;</span>
    <span class="n">df</span><span class="err">$</span><span class="n">actor2type</span><span class="p">[</span><span class="n">check2</span><span class="o">==</span> <span class="err">&#39;</span><span class="n">GOV</span><span class="err">&#39;</span> <span class="o">|</span> <span class="n">check2</span><span class="o">==</span><span class="err">&#39;</span><span class="n">MIL</span><span class="err">&#39;</span> <span class="o">|</span> <span class="n">check2</span><span class="o">==</span><span class="err">&#39;</span><span class="n">JUD</span><span class="err">&#39;</span> <span class="o">|</span>
    <span class="n">check2</span><span class="o">==</span><span class="err">&#39;</span><span class="n">PTY</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">GOV</span><span class="err">&#39;</span>
    <span class="n">df</span><span class="err">$</span><span class="n">actor1type</span><span class="p">[</span><span class="n">check1</span><span class="o">==</span> <span class="err">&#39;</span><span class="n">REB</span><span class="err">&#39;</span> <span class="o">|</span> <span class="n">check1</span><span class="o">==</span><span class="err">&#39;</span><span class="n">INS</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">REB</span><span class="err">&#39;</span>
    <span class="n">df</span><span class="err">$</span><span class="n">actor2type</span><span class="p">[</span><span class="n">check2</span><span class="o">==</span> <span class="err">&#39;</span><span class="n">REB</span><span class="err">&#39;</span> <span class="o">|</span> <span class="n">check2</span><span class="o">==</span><span class="err">&#39;</span><span class="n">INS</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">REB</span><span class="err">&#39;</span>
    <span class="n">df</span><span class="err">$</span><span class="n">actor1type</span><span class="p">[</span><span class="n">check1</span><span class="o">==</span> <span class="err">&#39;</span><span class="n">EDU</span><span class="err">&#39;</span> <span class="o">|</span> <span class="n">check1</span><span class="o">==</span><span class="err">&#39;</span><span class="n">MED</span><span class="err">&#39;</span> <span class="o">|</span> <span class="n">check1</span><span class="o">==</span><span class="err">&#39;</span><span class="n">HLH</span><span class="err">&#39;</span> <span class="o">|</span> 
    <span class="n">check1</span><span class="o">==</span><span class="err">&#39;</span><span class="n">CVL</span><span class="err">&#39;</span> <span class="o">|</span> <span class="n">check1</span><span class="o">==</span><span class="err">&#39;</span><span class="n">BUS</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">SOC</span><span class="err">&#39;</span>
    <span class="n">df</span><span class="err">$</span><span class="n">actor2type</span><span class="p">[</span><span class="n">check2</span><span class="o">==</span> <span class="err">&#39;</span><span class="n">EDU</span><span class="err">&#39;</span> <span class="o">|</span> <span class="n">check2</span><span class="o">==</span><span class="err">&#39;</span><span class="n">MED</span><span class="err">&#39;</span> <span class="o">|</span> <span class="n">check2</span><span class="o">==</span><span class="err">&#39;</span><span class="n">HLH</span><span class="err">&#39;</span> <span class="o">|</span>
    <span class="n">check2</span><span class="o">==</span><span class="err">&#39;</span><span class="n">CVL</span><span class="err">&#39;</span> <span class="o">|</span> <span class="n">check2</span><span class="o">==</span><span class="err">&#39;</span><span class="n">BUS</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">SOC</span><span class="err">&#39;</span>
    <span class="n">df</span><span class="err">$</span><span class="n">actor1type</span><span class="p">[</span><span class="n">check1</span><span class="o">==</span><span class="err">&#39;</span><span class="n">NGO</span><span class="err">&#39;</span> <span class="o">|</span> <span class="n">check1</span><span class="o">==</span><span class="err">&#39;</span><span class="n">IGO</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">IOS</span><span class="err">&#39;</span>
    <span class="n">df</span><span class="err">$</span><span class="n">actor2type</span><span class="p">[</span><span class="n">check2</span><span class="o">==</span><span class="err">&#39;</span><span class="n">NGO</span><span class="err">&#39;</span> <span class="o">|</span> <span class="n">check2</span><span class="o">==</span><span class="err">&#39;</span><span class="n">IGO</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">IOS</span><span class="err">&#39;</span>
    <span class="n">df</span><span class="err">$</span><span class="n">actor1type</span><span class="p">[</span><span class="n">check1</span><span class="o">==</span><span class="err">&#39;</span><span class="n">USA</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">USA</span><span class="err">&#39;</span>
    <span class="n">df</span><span class="err">$</span><span class="n">actor2type</span><span class="p">[</span><span class="n">check2</span><span class="o">==</span><span class="err">&#39;</span><span class="n">USA</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">USA</span><span class="err">&#39;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">na</span><span class="p">.</span><span class="n">omit</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p>The next section iterates over the potential combinations of actor types and 
variable types, checks that they are in <code>variables</code>, and creates a new column
if they are listed. It then puts a 1 in a column if the observation corresponds 
to that variable. It also creates columns ending in <code>gold</code> that record the Goldstein
score for that actor combination. If you're aggregating on something other than
quad categories, you may want to hash out the second 'if' section.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre>    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Creating</span> <span class="n">count</span> <span class="n">variables</span><span class="p">...</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="k">for</span><span class="p">(</span><span class="n">name1</span> <span class="n">in</span> <span class="n">var_actors</span><span class="p">){</span>
        <span class="k">for</span><span class="p">(</span><span class="n">name2</span> <span class="n">in</span> <span class="n">var_actors</span><span class="p">){</span>
            <span class="k">for</span><span class="p">(</span><span class="n">var_type</span> <span class="n">in</span> <span class="n">names</span><span class="p">(</span><span class="n">var_types</span><span class="p">)){</span>
                <span class="n">var_name</span> <span class="o">=</span> <span class="n">paste</span><span class="p">(</span><span class="n">name1</span><span class="p">,</span> <span class="n">name2</span><span class="p">,</span> <span class="n">var_type</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="sc">&#39;_&#39;</span><span class="p">)</span>
                <span class="n">var_gold</span> <span class="o">=</span> <span class="n">paste</span><span class="p">(</span><span class="n">name1</span><span class="p">,</span> <span class="n">name2</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">gold</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="sc">&#39;_&#39;</span><span class="p">)</span>
                <span class="k">if</span><span class="p">(</span><span class="n">is</span><span class="p">.</span><span class="n">element</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">variables</span><span class="p">)){</span>
                    <span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">is</span> <span class="n">a</span> <span class="n">variable</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="sc">&#39; &#39;</span><span class="p">))</span>
                    <span class="n">check1</span> <span class="o">=</span> <span class="n">df</span><span class="err">$</span><span class="n">actor1type</span>
                    <span class="n">check2</span> <span class="o">=</span> <span class="n">df</span><span class="err">$</span><span class="n">actor2type</span>
                    <span class="n">check3</span> <span class="o">=</span> <span class="n">df</span><span class="err">$</span><span class="n">quad</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">df</span><span class="p">[[</span><span class="n">var_name</span><span class="p">]][</span><span class="n">check1</span> <span class="o">==</span> <span class="n">toupper</span><span class="p">(</span><span class="n">name1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">check2</span> <span class="o">==</span> <span class="n">toupper</span><span class="p">(</span><span class="n">name2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">check3</span>
                    <span class="o">==</span> <span class="n">var_types</span><span class="p">[[</span><span class="n">var_type</span><span class="p">]]]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="p">}</span>
                <span class="k">if</span><span class="p">(</span><span class="n">is</span><span class="p">.</span><span class="n">element</span><span class="p">(</span><span class="n">var_gold</span><span class="p">,</span> <span class="n">variables</span><span class="p">)){</span>
                    <span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="n">var_gold</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">is</span> <span class="n">a</span> <span class="n">variable</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="sc">&#39;_&#39;</span><span class="p">))</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">var_gold</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">var_gold</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="err">$</span><span class="n">goldstein</span>
                    <span class="n">check1</span> <span class="o">=</span> <span class="n">df</span><span class="err">$</span><span class="n">actor1type</span>
                    <span class="n">check2</span> <span class="o">=</span> <span class="n">df</span><span class="err">$</span><span class="n">actor2type</span>
                    <span class="n">df</span><span class="p">[[</span><span class="n">var_gold</span><span class="p">]][</span><span class="n">check1</span> <span class="o">!=</span> <span class="n">toupper</span><span class="p">(</span><span class="n">name1</span><span class="p">)</span> <span class="o">|</span> <span class="n">check2</span> <span class="o">!=</span> <span class="n">toupper</span><span class="p">(</span><span class="n">name2</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>
</td></tr></table>

<p>This final section aggregates the data by country, year, and month. If you decide
that you want to aggregate by day as well, just make sure that your day variable
is included in lines 13 and 14 of this section. I had to use <code>tryCatch</code> in order
to skip countries in <code>all_actors</code> that didn't experience any events. This is really
only a problem if you're aggregating over a short time frame. </p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight"><pre>    <span class="nx">final_df</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">frame</span><span class="p">()</span>
    <span class="nx">print</span><span class="p">(</span><span class="s1">&#39;Creating groupings...&#39;</span><span class="p">)</span>
    <span class="k">for</span><span class="p">(</span><span class="nx">actor</span> <span class="k">in</span> <span class="nx">all_actors</span><span class="p">){</span>
        <span class="nx">print</span><span class="p">(</span><span class="nx">paste</span><span class="p">(</span><span class="s1">&#39;Processing&#39;</span><span class="p">,</span> <span class="nx">actor</span><span class="p">,</span> <span class="nx">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
        <span class="nx">check1</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nx">df$Actor1Code</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="nx">check2</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nx">df$Actor2Code</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="nx">actor_dataset</span> <span class="o">=</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">df</span><span class="p">,</span> <span class="p">(</span><span class="nx">check1</span><span class="o">==</span><span class="nx">actor</span> <span class="o">&amp;</span> <span class="nx">check2</span><span class="o">==</span><span class="nx">actor</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">check1</span><span class="o">==</span><span class="nx">actor</span> <span class="o">&amp;</span> <span class="nx">check2</span><span class="o">==</span><span class="s1">&#39;USA&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">check1</span><span class="o">==</span><span class="s1">&#39;USA&#39;</span> <span class="o">&amp;</span> <span class="nx">check2</span><span class="o">==</span><span class="nx">actor</span><span class="p">))</span>
        <span class="nx">actor_dataset$Actor1Code</span> <span class="o">=</span> <span class="nx">actor_dataset$Actor2Code</span> <span class="o">=</span> <span class="nx">actor_dataset$quad</span> <span class="o">=</span> 
        <span class="nx">actor_dataset$goldstein</span> <span class="o">=</span> <span class="nx">actor_dataset$actor1type</span> <span class="o">=</span> <span class="nx">actor_dataset$actor2type</span> <span class="o">=</span> <span class="nx">NULL</span>
        <span class="nx">tryCatch</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="nx">actor_dataset$country</span> <span class="o">=</span> <span class="nx">actor</span>
                <span class="nx">am</span> <span class="o">=</span> <span class="nx">melt</span><span class="p">(</span><span class="nx">actor_dataset</span><span class="p">,</span> <span class="nx">id</span><span class="p">.</span><span class="nx">vars</span><span class="o">=</span><span class="nx">c</span><span class="p">(</span><span class="s1">&#39;country&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span><span class="s1">&#39;year&#39;</span><span class="p">),</span> <span class="nx">na</span><span class="p">.</span><span class="nx">rm</span><span class="o">=</span><span class="nx">TRUE</span><span class="p">)</span>
                <span class="nx">actor_dataset</span> <span class="o">=</span> <span class="nx">dcast</span><span class="p">(</span><span class="nx">am</span><span class="p">,</span> <span class="nx">country</span><span class="o">+</span><span class="nx">month</span><span class="o">+</span><span class="nx">year</span><span class="o">~</span><span class="nx">variable</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="kd">var</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> 
                <span class="nx">fun</span><span class="p">.</span><span class="nx">aggregate</span><span class="o">=</span><span class="nx">sum</span><span class="p">)</span>
                <span class="nx">final_df</span> <span class="o">=</span> <span class="nx">rbind</span><span class="p">(</span><span class="nx">final_df</span><span class="p">,</span> <span class="nx">actor_dataset</span><span class="p">)</span>
                <span class="p">},</span>
                <span class="nx">error</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">cond</span><span class="p">){</span>
                    <span class="nx">message</span><span class="p">(</span><span class="nx">paste</span><span class="p">(</span><span class="s1">&#39;Skipped&#39;</span><span class="p">,</span><span class="nx">actor</span><span class="p">,</span> <span class="nx">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
                    <span class="nx">message</span><span class="p">(</span><span class="nx">cond</span><span class="p">)</span>
                <span class="p">},</span>
                <span class="k">finally</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="nx">message</span><span class="p">(</span><span class="nx">paste</span><span class="p">(</span><span class="s1">&#39;Processed&#39;</span><span class="p">,</span> <span class="nx">actor</span><span class="p">,</span> <span class="nx">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
                <span class="p">}</span>
            <span class="p">)</span>
    <span class="p">}</span>
<span class="k">return</span><span class="p">(</span><span class="nx">final_df</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>This can take a while to run on the full ICEWS dataset, so I'll probably set this
up to run in parallel at some point in the near to distant future. If you happen to run into any errors
using this, please let me know. There's only so much testing I can do myself.</p>

                <div class="clear"></div>
                <div class="info">
                    <a href="./aggregating-icews-data-in-r.html">posted at 00:00</a>
                </div>

            </article>
            <div class="clear"></div>
            <div class="clear"></div>
            <footer>
                <p>
                <a href="https://github.com/jody-frankowski/blue-penguin">Blue Penguin</a> Theme
                &middot;
                Powered by <a href="http://getpelican.com">Pelican</a>
            </footer>
        </div>
        <div class="clear"></div>
    </div>
</body>
</html>